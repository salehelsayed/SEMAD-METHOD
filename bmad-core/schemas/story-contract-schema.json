{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Story Contract Schema",
  "type": "object",
  "required": [
    "version",
    "story_id",
    "epic_id",
    "schemaVersion"
  ],
  "properties": {
    "version": {
      "type": "string"
    },
    "story_id": {
      "type": "string"
    },
    "acceptanceTestMatrix": {
      "type": "object",
      "properties": {
        "policy": {
          "type": "object",
          "properties": {
            "test_runner": { "type": "string" },
            "max_tests_per_ac": { "type": ["number", "string"] },
            "must_cover": { "type": "array", "items": { "type": "string" } },
            "skip_criteria": { "type": "array", "items": { "type": "string" } },
            "rationale_required": { "type": "boolean" }
          },
          "additionalProperties": true
        },
        "globals": {
          "type": "object",
          "additionalProperties": true
        },
        "items": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["ac_id", "title", "test_files"],
            "properties": {
              "ac_id": { "type": "string" },
              "title": { "type": "string" },
              "type": { "type": "string" },
              "endpoint_ref": { "type": "object", "additionalProperties": true },
              "preconditions": { "type": "array", "items": { "type": "string" } },
              "request": { "type": "object", "additionalProperties": true },
              "assertions": { "type": "array", "items": { "type": ["string", "object", "number"] } },
              "test_files": { "type": "array", "items": { "type": "object", "properties": { "path": { "type": "string" }, "framework": { "type": "string" } }, "required": ["path"] } },
              "must_have": { "type": "boolean" },
              "rationale": { "type": "string" }
            },
            "additionalProperties": true
          }
        }
      },
      "additionalProperties": true
    },
    "developmentPolicy": {
      "type": "object",
      "properties": {
        "tdd": { "type": "boolean" },
        "test_source": { "type": "string" },
        "required_sequence": { "type": "array", "items": { "type": "string" } },
        "max_tests_per_ac": { "type": ["number", "string"] },
        "skip_criteria": { "type": "array", "items": { "type": "string" } },
        "rationale_required": { "type": "boolean" }
      },
      "additionalProperties": true
    },
    "qaValidationPolicy": {
      "type": "object",
      "properties": {
        "enforce_tdd": { "type": "boolean" },
        "checks": { "type": "array", "items": { "type": "string" } },
        "exceptions_allowed": { "type": "array", "items": { "type": "string" } },
        "exception_requires": { "type": "string" }
      },
      "additionalProperties": true
    },
    "epic_id": {
      "type": "string"
    },
    "schemaVersion": {
      "type": "string",
      "description": "Version of this schema"
    },
    "preConditions": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Conditions that must be met before story execution"
    },
    "postConditions": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Conditions that must be met after story completion"
    },
    "linkedArtifacts": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "type",
          "path",
          "version"
        ],
        "properties": {
          "type": {
            "type": "string"
          },
          "path": {
            "type": "string"
          },
          "version": {
            "type": "string"
          }
        }
      },
      "description": "Artifacts linked to this story"
    },
    "apiEndpoints": {
      "type": "array",
      "items": {
        "type": "string"
      }
    },
    "filesToModify": {
      "type": "array",
      "items": {
        "type": "object",
        "required": [
          "path",
          "reason"
        ],
        "properties": {
          "path": {
            "type": "string"
          },
          "reason": {
            "type": "string"
          }
        }
      }
    },
    "acceptanceCriteriaLinks": {
      "type": "array",
      "items": {
        "type": "string"
      }
    }
  }
}
